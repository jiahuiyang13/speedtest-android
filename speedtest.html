<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speed Check</title>
<style>
  body{font:16px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;margin:0;padding:20px}
  #s{white-space:pre-line}
</style>
<div id="s">Running network speed test…</div>

<script>
/* ====== CONFIG ====== */
const COLLECTOR_URL = "https://script.google.com/macros/s/AKfycbwsdxYyIKa3QRzsrjUISq660hZaLxTLlDXwzjxNWL3l0wriqi3Mrfs7OjC4xTJl-saj3w/exec";
const SECRET        = "secretkey";

/* size/time knobs */
const WARMUP_BYTES = 8_000_000;      // ~8 MB
const PROBE_BYTES  = 25_000_000;     // ~25 MB
const WARMUP_TO    = 30;             // seconds
const PROBE_TO     = 45;             // seconds
const RUNS         = 3;              // set to 1 for single sample

/* ====== UI helpers ====== */
const qs   = new URL(location.href).searchParams;
const debugMode = qs.has("debug");
function statusMsg(t){ try{ document.getElementById("s").textContent = t; }catch{} }
function finish(ok, msg){
  statusMsg((ok ? "OK: " : "FAILED: ") + (msg || ""));
  if (!debugMode) setTimeout(()=>{ try{ window.close(); }catch{} }, 1500);
}

/* ====== Device name resolution ======
   Priority:
   1) Scalefusion JS bridge -> info.device_name
   2) ?device= query param (expanded when launched via workflows that support macros)
   3) If missing or literal "$deviceName$", parse Android model from UA
*/
function getDeviceNameViaBridge(){
  return new Promise((resolve) => {
    try{
      if (window.Scalefusion && typeof window.Scalefusion.deviceInfo === "function"){
        // callback style API
        window.Scalefusion.deviceInfo((info)=>{
          if (info && (info.device_name || info.deviceName)) {
            resolve(String(info.device_name || info.deviceName).trim());
            return;
          }
          resolve(null);
        });
        // some builds expose promise
        return;
      }
    }catch(e){}
    resolve(null);
  });
}
function deviceNameFromUA(){
  const ua = navigator.userAgent || "";
  // Grab model between semicolon and "Build"
  const m = ua.match(/Android [^;]*; *([^;)]*?) *Build/i);
  if (m && m[1]) return m[1].trim();
  // Fallback: parenthetical block
  const p = ua.match(/\((Android[^;]*;[^)]*)\)/);
  if (p && p[1]) return p[1].trim();
  return "Android";
}
async function getDeviceName(){
  // 1) Scalefusion bridge
  const bridged = await getDeviceNameViaBridge();
  if (bridged) return bridged.substring(0,128);

  // 2) Query string
  let d = (qs.get("device") || "").trim();

  // 3) If not present or literal macro, fallback to UA
  if (!d || d === "$deviceName$" || d === "$serialNumber$") {
    d = deviceNameFromUA();
  }
  return d.substring(0,128) || "Android";
}

/* ====== Network probes (no installs) ====== */
async function httpProbe(bytes, timeoutSec){
  const url = `https://speed.cloudflare.com/__down?bytes=${bytes}&nonce=${Math.random().toString(36).slice(2)}`;
  const ctrl = new AbortController();
  const tid  = setTimeout(()=>ctrl.abort(), timeoutSec*1000);

  const t0 = performance.now();
  const res = await fetch(url, {signal: ctrl.signal, cache:"no-store"});
  const reader = res.body.getReader();
  let total = 0;
  for(;;){
    const {done, value} = await reader.read();
    if (done) break;
    total += value.byteLength;
  }
  clearTimeout(tid);
  const sec = (performance.now() - t0)/1000;
  if (sec <= 0) throw new Error("zero time");
  return (total*8/1e6)/sec; // Mbps
}
function median(arr){
  if (!arr || !arr.length) return NaN;
  const s = arr.slice().sort((a,b)=>a-b);
  const m = Math.floor(s.length/2);
  return s.length%2 ? s[m] : (s[m-1]+s[m])/2;
}

/* ====== Upload helpers ====== */
async function getPublicIP(){
  try{
    const r = await fetch("https://api.ipify.org?format=json", {cache:"no-store"});
    return (await r.json()).ip || "";
  }catch{ return ""; }
}
async function postOrGetFallback(url, body){
  // POST
  try{
    const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
    const t = await r.text();
    if (r.ok && !/^Forbidden|^ERR:/i.test(t)) return true;
  }catch{}
  // GET fallback
  const q = new URLSearchParams({
    secret: body.secret,
    device: body.device,
    timestamp: body.timestamp,
    public_ip: body.public_ip,
    download_mbps: String(body.download_mbps ?? "")
  });
  try{
    const g = await fetch(url + (url.includes("?")?"&":"?") + q.toString(), {method:"GET"});
    const tt = await g.text();
    return g.ok && !/^Forbidden|^ERR:/i.test(tt);
  }catch{ return false; }
}

/* ====== Main ====== */
(async function(){
  statusMsg("Resolving device identity…");
  const device = await getDeviceName();

  statusMsg("Getting public IP…");
  const public_ip = await getPublicIP();

  // Warmup (ignore value)
  statusMsg("Warming up network…");
  try{ await httpProbe(WARMUP_BYTES, WARMUP_TO); }catch{}

  // Main runs
  statusMsg("Running download probe…");
  const samples = [];
  for (let i=0;i<RUNS;i++){
    try{
      const v = await httpProbe(PROBE_BYTES, PROBE_TO);
      samples.push(v);
      if (debugMode) statusMsg(`Running download probe…\nSample ${i+1}/${RUNS}: ${v.toFixed(2)} Mbps`);
    }catch(e){
      if (debugMode) statusMsg(`Probe ${i+1} failed: ${e && e.message || e}`);
    }
  }
  const mbps = median(samples);
  const rounded = Number.isFinite(mbps) ? Math.round(mbps*100)/100 : null;

  statusMsg("Uploading result…");
  const payload = {
    secret: SECRET,
    timestamp: new Date().toISOString(),
    device,
    public_ip,
    download_mbps: rounded
  };

  const ok = await postOrGetFallback(COLLECTOR_URL, payload);
  finish(ok, ok ? `${rounded} Mbps` : `upload failed`);
})();
</script>
