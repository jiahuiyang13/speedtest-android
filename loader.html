<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Starting…</title>
<style>
  body { margin:0; font:16px system-ui; }
  #msg { padding:16px }
  /* Hidden background runner */
  iframe { position:absolute; width:1px; height:1px; left:-9999px; top:-9999px; border:0; }
</style>
<div id="msg">Launching…</div>

<script>
/* ================== CONFIG ================== */
const SPEEDTEST_BASE = "https://jiahuiyang13.github.io/speedtest-android/speedtest.html";
const LUCKLAKE_URL   = "https://app.lucklake.com/terminal/demo/merchandising/?categoryId=18&trackingCode=unassigned-android";
const REDIRECT_DELAY_MS = 3500;     // time to let the test start (3.5s)
const RUN_INTERVAL_HOURS = 6;       // run at most once per 6 hours (set 0 to run every time)
/* ============================================ */

main().catch(e => { console.error(e); location.replace(LUCKLAKE_URL); });

async function main(){
  const devName = await getDeviceName();         // from ?device=… or fabricate stable
  const now = Date.now();
  const key = "speedtest_last_run";
  const last = Number(localStorage.getItem(key) || 0);
  const tooSoon = RUN_INTERVAL_HOURS > 0 && (now - last) < RUN_INTERVAL_HOURS*3600*1000;

  if (!tooSoon) {
    const testUrl = SPEEDTEST_BASE + "?device=" + encodeURIComponent(devName);
    startHidden(testUrl);
    localStorage.setItem(key, String(now));
  }

  // Always proceed to your production app
  setTimeout(() => location.replace(LUCKLAKE_URL), REDIRECT_DELAY_MS);
}

function startHidden(url){
  const ifr = document.createElement("iframe");
  ifr.src = url;        // speedtest runs + posts to your sheet inside the iframe
  document.body.appendChild(ifr);
  document.getElementById("msg").textContent = "Checking network…";
}

// Prefer URL ?device=… ; otherwise fabricate stable ll/lc4xx pattern
async function getDeviceName(){
  const qs = new URL(location.href).searchParams;
  let d = (qs.get("device") || "").trim();
  if (d && !/^\$[^$]+\$/.test(d)) return d.slice(0,128);

  // reuse if previously generated
  const cached = localStorage.getItem("sf_name");
  if (cached) return cached;

  // seed with public IP + UA (best effort)
  let ip = "";
  try {
    const r = await fetch("https://api.ipify.org?format=json",{cache:"no-store"});
    ip = (await r.json()).ip || "";
  } catch {}
  const ua = navigator.userAgent || "";
  const seed = ip + "|" + ua;

  // djb2 hash → deterministic ll/lc + 400..499 + tb
  let h = 5381;
  for (let i=0;i<seed.length;i++){ h=((h<<5)+h)+seed.charCodeAt(i); h|=0; }
  const abs = Math.abs(h);
  const num = 400 + (abs % 100);                 // 400..499
  const prefix = (abs % 2 === 0) ? "ll" : "lc";  // ll / lc
  const name = `${prefix}${num}tb`;
  localStorage.setItem("sf_name", name);
  return name;
}
</script>
